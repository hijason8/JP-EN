<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JP-EN</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="JP-EN">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/hijason8/JP-EN/main/snapchat.png">
    <style>
        :root {
            --primary: #5856D6;
            --bg: #F2F2F7;
            --card-bg: #FFFFFF;
            --text: #1C1C1E;
            --gray: #8E8E93;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; overflow: hidden;
        }
        .stats-header { font-size: 14px; color: var(--gray); margin-bottom: 10px; }
        
        /* 單字卡片 */
        .card {
            width: 100%; max-width: 350px; height: 250px;
            background: var(--card-bg);
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: center;
            flex-direction: column;
            cursor: pointer; position: relative;
            border: 1px solid rgba(0,0,0,0.03);
        }
        .card h1 { font-size: 42px; margin: 0; color: var(--text); }
        .card p { font-size: 24px; color: var(--primary); margin-top: 15px; display: none; }

        /* 答題按鈕 */
        .btn-group {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 12px; width: 100%; max-width: 350px; margin-top: 30px;
        }
        .btn-ans {
            border: none; padding: 18px 0; border-radius: 15px;
            color: white; font-weight: 600; font-size: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .btn-hard { background: #FF3B30; }
        .btn-mid { background: #FF9500; }
        .btn-easy { background: #34C759; }

        /* 底部系統按鈕 */
        .system-controls {
            display: flex; gap: 10px; width: 100%; max-width: 350px;
            margin-top: auto; padding-bottom: 30px;
        }
        .btn-sys {
            flex: 1; background: var(--gray); color: white; border: none;
            padding: 10px 0; border-radius: 10px; font-size: 12px;
        }

        /* 跳窗式查看清單 (Modal) */
        #modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100;
        }
        .modal-content {
            background: white; margin: 10% auto; width: 85%; max-width: 400px;
            border-radius: 20px; padding: 20px; height: 70vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .close-btn { font-size: 24px; cursor: pointer; color: var(--gray); }
        .word-item { border-bottom: 1px solid #F2F2F7; padding: 10px 0; font-size: 14px; }
    </style>
</head>
<body>

    <div class="stats-header" id="countDisplay">今日剩餘: 0</div>

    <div class="card" onclick="toggleAnswer()">
        <h1 id="wordDisplay">請匯入單字</h1>
        <p id="translationDisplay"></p>
    </div>

    <div class="btn-group">
        <button class="btn-ans btn-hard" onclick="handleAnswer(1)">重來</button>
        <button class="btn-ans btn-mid" onclick="handleAnswer(3)">普通</button>
        <button class="btn-ans btn-easy" onclick="handleAnswer(5)">簡單</button>
    </div>

    <div class="system-controls">
        <button class="btn-sys" onclick="document.getElementById('fileInput').click()">匯入</button>
        <button class="btn-sys" onclick="exportBackup()">匯出</button>
        <button class="btn-sys" onclick="showModal()">查看</button>
    </div>

    <input type="file" id="fileInput" style="display:none" onchange="importBackup(event)">

    <div id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <strong style="font-size: 18px;">單字強度分析</strong>
                <span class="close-btn" onclick="hideModal()">&times;</span>
            </div>
            <div id="statsContainer"></div>
        </div>
    </div>

    <script>
        let words = JSON.parse(localStorage.getItem('anki_jp_db')) || [];
        let currentCard = null;

        // 隨機抽題邏輯
        function nextCard() {
            const now = Date.now();
            let dueWords = words.filter(w => w.next <= now);
            
            if (dueWords.length === 0) {
                document.getElementById('wordDisplay').innerText = "全部完成！";
                document.getElementById('translationDisplay').innerText = "";
                document.getElementById('countDisplay').innerText = "今日挑戰已達成";
                currentCard = null;
                return;
            }

            // 隨機挑選一個到期的單字
            currentCard = dueWords[Math.floor(Math.random() * dueWords.length)];
            document.getElementById('wordDisplay').innerText = currentCard.w;
            document.getElementById('translationDisplay').innerText = currentCard.t;
            document.getElementById('translationDisplay').style.display = 'none';
            document.getElementById('countDisplay').innerText = `待複習: ${dueWords.length}`;
        }

        function toggleAnswer() {
            const t = document.getElementById('translationDisplay');
            t.style.display = (t.style.display === 'none') ? 'block' : 'none';
        }

        function handleAnswer(quality) {
            if (!currentCard) return;

            // 簡易 SM-2 演算法
            if (quality < 3) {
                currentCard.iv = 0;
            } else {
                currentCard.iv = currentCard.iv === 0 ? 1 : Math.ceil(currentCard.iv * 2.5);
            }
            
            // 設定下次出現時間 (天數轉毫秒)
            currentCard.next = Date.now() + (currentCard.iv * 86400000);
            
            saveData();
            nextCard();
        }

        function saveData() {
            localStorage.setItem('anki_jp_db', JSON.stringify(words));
        }

        function exportBackup() {
            const data = JSON.stringify(words);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `anki_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function importBackup(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                words = JSON.parse(event.target.result);
                saveData();
                nextCard();
                alert("匯入成功！");
            };
            reader.readAsText(file);
        }

        // 跳窗控制
        function showModal() {
            const container = document.getElementById('statsContainer');
            words.sort((a, b) => b.iv - a.iv);
            container.innerHTML = words.map(w => `
                <div class="word-item">
                    <strong>${w.w}</strong> <span style="float:right">強度: ${w.iv}d</span><br>
                    <small style="color:gray">下次: ${w.next === 0 ? '未開始' : new Date(w.next).toLocaleDateString()}</small>
                </div>
            `).join('');
            document.getElementById('modal').style.display = 'block';
        }

        function hideModal() { document.getElementById('modal').style.display = 'none'; }

        // 初始啟動
        nextCard();
    </script>
</body>
</html>
