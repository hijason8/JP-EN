<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JP-EN Flashcards</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="JP-EN">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/hijason8/JP-EN/main/snapchat.png">
    <style>
        :root { --primary: #5856D6; --bg: #F2F2F7; --card-bg: #FFFFFF; --text: #1C1C1E; --gray: #8E8E93; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        .stats-header { font-size: 14px; color: var(--gray); margin-bottom: 10px; }
        .card { width: 100%; max-width: 350px; height: 250px; background: var(--card-bg); border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; border: 1px solid rgba(0,0,0,0.03); text-align: center; padding: 20px; box-sizing: border-box; position: relative; }
        .card h1 { font-size: 42px; margin: 0; color: var(--text); word-break: break-all; }
        .card p { font-size: 24px; color: var(--primary); margin-top: 15px; display: none; }
        .btn-group { display: none; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 100%; max-width: 350px; margin-top: 30px; }
        .btn-ans { border: none; padding: 18px 0; border-radius: 15px; color: white; font-weight: 600; font-size: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; transition: opacity 0.2s; }
        .btn-ans:active { opacity: 0.7; }
        .btn-hard { background: #FF3B30; } .btn-mid { background: #FF9500; } .btn-easy { background: #34C759; }
        .system-controls { display: flex; gap: 10px; width: 100%; max-width: 350px; margin-top: auto; padding-bottom: 30px; }
        .btn-sys { flex: 1; background: var(--gray); color: white; border: none; padding: 10px 0; border-radius: 10px; font-size: 12px; cursor: pointer; }
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; }
        .modal-content { background: white; margin: 10% auto; width: 85%; max-width: 400px; border-radius: 20px; padding: 20px; height: 70vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .close-btn { font-size: 28px; cursor: pointer; color: var(--gray); }
        .word-item { border-bottom: 1px solid #F2F2F7; padding: 12px 0; font-size: 14px; }
    </style>
</head>
<body>
    <div class="stats-header" id="countDisplay">Due: 0 | New: 0/20</div>
    <div class="card" onclick="toggleAnswer()">
        <h1 id="wordDisplay">Loading...</h1>
        <p id="translationDisplay"></p>
        <small id="tapTip" style="color: #C7C7CC; position: absolute; bottom: 15px;">Tap to reveal</small>
    </div>
    <div class="btn-group">
        <button class="btn-ans btn-hard" onclick="handleAnswer(1)">Again</button>
        <button class="btn-ans btn-mid" onclick="handleAnswer(3)">Hard</button>
        <button class="btn-ans btn-easy" onclick="handleAnswer(5)">Easy</button>
    </div>
    <div class="system-controls">
        <button class="btn-sys" onclick="document.getElementById('fileInput').click()">Import</button>
        <button class="btn-sys" onclick="exportBackup()">Export</button>
        <button class="btn-sys" onclick="showModal()">Review All</button>
    </div>
    <input type="file" id="fileInput" style="display:none" onchange="importBackup(event)">
    <div id="modal"><div class="modal-content"><div class="modal-header"><strong>Library</strong><span class="close-btn" onclick="hideModal()">&times;</span></div><div id="statsContainer"></div></div></div>

<script>
const gasUrl = "https://script.google.com/macros/s/AKfycbwy-KDZX5A2SJCgaTMWG4ueKbFIDAhTyhXh-V8k9kcNxk32gKrYpAGfRljbHHsC5xBz-g/exec"; // ⚠️ 貼上剛剛部署完的 /exec 網址
const NEW_CARDS_LIMIT = 20;
let words = [];
let currentCard = null;

// 1. 初始化：從雲端抓取資料
async function init() {
    try {
        const res = await fetch(`${gasUrl}?action=pull`);
        if (!res.ok) throw new Error();
        words = await res.json();
    } catch (e) {
        console.log("Using local backup.");
        words = JSON.parse(localStorage.getItem('anki_jp_db')) || [];
    }
    nextCard(); // 資料拿到了，開始抽第一張牌
}

// 2. 抽題演算法
function nextCard() {
    const now = Date.now();
    const todayStr = new Date().toLocaleDateString();

    let dueWords = words.filter(w => w.iv >= 0 && w.next <= now);
    let learnedNewToday = words.filter(w => w.firstSeen === todayStr && w.iv > 0).length;

    if (dueWords.length > 0) {
        let pool = dueWords.length > 1 
            ? dueWords.filter(w => w.w !== (currentCard ? currentCard.w : "")) 
            : dueWords;
        currentCard = pool[Math.floor(Math.random() * pool.length)];
    } else if (learnedNewToday < NEW_CARDS_LIMIT) {
        let newWords = words.filter(w => w.iv === 0 && !w.firstSeen);
        if (newWords.length > 0) {
            currentCard = newWords[0];
        } else {
            currentCard = null;
        }
    } else {
        currentCard = null;
    }

    // 呼叫顯示函數
    renderUI(dueWords.length, learnedNewToday);
}

// 3. 介面渲染函數 (就是你剛剛問的那段)
function renderUI(dueCount, learnedCount) {
    const wordDisp = document.getElementById('wordDisplay');
    const transDisp = document.getElementById('translationDisplay');
    const countDisp = document.getElementById('countDisplay');
    const btnGroup = document.querySelector('.btn-group');
    const tapTip = document.getElementById('tapTip');

    if (!currentCard) {
        let laterToday = words.filter(w => w.iv >= 0 && w.next > Date.now() && w.next <= new Date().setHours(23,59,59,999));
        wordDisp.innerText = (laterToday.length > 0) ? "Queue Cleared" : "All Done!";
        transDisp.innerText = (laterToday.length > 0) 
            ? `${laterToday.length} cards scheduled for later today.` 
            : "See you tomorrow!";
        transDisp.style.display = 'block';
        if(btnGroup) btnGroup.style.display = 'none';
        if(tapTip) tapTip.style.display = 'none';
        countDisp.innerText = `New Today: ${learnedCount}/${NEW_CARDS_LIMIT}`;
        return;
    }

    wordDisp.innerText = currentCard.w;
    transDisp.innerText = currentCard.t;
    transDisp.style.display = 'none';
    if(btnGroup) btnGroup.style.display = 'none';
    if(tapTip) tapTip.style.display = 'block';
    countDisp.innerText = `Due: ${dueCount} | New Today: ${learnedCount}/${NEW_CARDS_LIMIT}`;
    
    // 只有在卡片出現時才發音
    speak(currentCard.w);
}

// 4. 答案處理 (與雲端同步)
async function handleAnswer(q) {
    if (!currentCard) return;
    const now = Date.now();
    const todayStr = new Date().toLocaleDateString();

    if (currentCard.iv === 0 && !currentCard.firstSeen) currentCard.firstSeen = todayStr;

    if (q < 3) {
        currentCard.iv = 0; 
        currentCard.next = now + 60000; 
    } else if (q === 3) {
        currentCard.iv = (currentCard.iv === 0) ? 0.5 : Math.ceil(currentCard.iv * 1.2);
        currentCard.next = now + 600000; 
    } else {
        currentCard.iv = (currentCard.iv === 0) ? 1 : Math.ceil(currentCard.iv * 2.5);
        currentCard.next = now + (currentCard.iv * 86400000);
    }
    
    localStorage.setItem('anki_jp_db', JSON.stringify(words));
    nextCard();

    // 靜默將資料推送到雲端試算表
    fetch(`${gasUrl}?action=push&data=${encodeURIComponent(JSON.stringify(words))}`, {mode: 'no-cors'});
}

// 5. 語音函數
async function speak(text) {
    try {
        const res = await fetch(`${gasUrl}?action=speak&text=${encodeURIComponent(text)}`);
        const data = await res.json();
        const audio = new Audio("data:audio/mp3;base64," + data.audioContent);
        audio.play().catch(() => {});
    } catch (e) {
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'ja-JP';
        window.speechSynthesis.speak(msg);
    }
}

// 6. UI 切換功能
function toggleAnswer() {
    if (!currentCard) return;
    document.getElementById('translationDisplay').style.display = 'block';
    document.querySelector('.btn-group').style.display = 'grid';
    document.getElementById('tapTip').style.display = 'none';

// 啟動程式
init();
</script>
</body>
</html>
