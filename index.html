<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JP>EN</title>
    
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/hijason8/JP-EN/refs/heads/main/snapchat.png">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/hijason8/JP-EN/refs/heads/main/snapchat.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Japanese Anki">

    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f4f4f9; }
        .card { background: white; padding: 40px 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin: 20px auto; max-width: 400px; min-height: 200px; cursor: pointer; }
        #wordDisplay { font-size: 48px; margin-bottom: 20px; }
        #translationDisplay { font-size: 24px; color: #666; display: none; }
        .btn-group { display: none; grid-template-columns: 1fr 1fr 1fr; gap: 10px; max-width: 400px; margin: 20px auto; }
        button { padding: 15px; border: none; border-radius: 8px; color: white; font-size: 16px; cursor: pointer; }
        .btn-again { background: #ff4444; }
        .btn-hard { background: #ffbb33; }
        .btn-easy { background: #00C851; }
        #countDisplay { margin-top: 20px; font-size: 14px; color: #888; }
        #tapTip { color: #bbb; font-size: 14px; }
    </style>
</head>
<body>

    <div class="card" onclick="toggleAnswer()">
        <div id="wordDisplay">Loading...</div>
        <div id="translationDisplay"></div>
        <div id="tapTip">Tap to reveal</div>
    </div>

    <div class="btn-group">
        <button class="btn-again" onclick="handleAnswer(1)">Again</button>
        <button class="btn-hard" onclick="handleAnswer(3)">Hard</button>
        <button class="btn-easy" onclick="handleAnswer(5)">Easy</button>
    </div>

    <div id="countDisplay">Connecting to cloud...</div>

    <script>
        const gasUrl = "https://script.google.com/macros/s/AKfycbzPkfNIp5y_hjT75Hv3ELbp7Uo6NBeXFIyvff2G_Dx7QEOPw6AZ3yUb-W4d7VJxkHH60A/exec";
        const NEW_CARDS_LIMIT = 20;
        let words = [];
        let currentCard = null;

        function renderUI(dueCount, learnedCount) {
            const wordDisp = document.getElementById('wordDisplay');
            const transDisp = document.getElementById('translationDisplay');
            const countDisp = document.getElementById('countDisplay');
            const btnGroup = document.querySelector('.btn-group');
            const tapTip = document.getElementById('tapTip');

            if (!currentCard) {
                let laterToday = words.filter(w => w.iv >= 0 && w.next > Date.now() && w.next <= new Date().setHours(23,59,59,999));
                wordDisp.innerText = (laterToday.length > 0) ? "Queue Cleared" : "All Done!";
                transDisp.innerText = (laterToday.length > 0) ? `${laterToday.length} cards scheduled for later.` : "See you tomorrow!";
                transDisp.style.display = 'block';
                if(btnGroup) btnGroup.style.display = 'none';
                if(tapTip) tapTip.style.display = 'none';
                countDisp.innerText = `New Today: ${learnedCount}/${NEW_CARDS_LIMIT}`;
                return;
            }

            wordDisp.innerText = currentCard.w;
            transDisp.innerText = currentCard.t;
            transDisp.style.display = 'none';
            if(btnGroup) btnGroup.style.display = 'none';
            if(tapTip) tapTip.style.display = 'block';
            countDisp.innerText = `Due: ${dueCount} | New Today: ${learnedCount}/${NEW_CARDS_LIMIT}`;
            speak(currentCard.w);
        }

        function nextCard() {
            const now = Date.now();
            const todayStr = new Date().toLocaleDateString();
            let dueWords = words.filter(w => w.iv >= 0 && w.next <= now && w.firstSeen);
            let learnedNewToday = words.filter(w => w.firstSeen === todayStr).length;

            if (dueWords.length > 0) {
                let pool = dueWords.length > 1 ? dueWords.filter(w => w.w !== (currentCard ? currentCard.w : "")) : dueWords;
                currentCard = pool[Math.floor(Math.random() * pool.length)];
            } else if (learnedNewToday < NEW_CARDS_LIMIT) {
                let newWords = words.filter(w => w.iv === 0 && !w.firstSeen);
                currentCard = newWords.length > 0 ? newWords[0] : null;
            } else {
                currentCard = null;
            }
            renderUI(dueWords.length, learnedNewToday);
        }

        async function init() {
            try {
                const res = await fetch(`${gasUrl}?action=pull`);
                if (!res.ok) throw new Error();
                words = await res.json();
            } catch (e) {
                console.log("Pull failed, using local storage.");
                words = JSON.parse(localStorage.getItem('anki_jp_db')) || [];
            }
            nextCard();
        }

        async function speak(text) {
            try {
                const res = await fetch(`${gasUrl}?action=speak&text=${encodeURIComponent(text)}`);
                const data = await res.json();
                const audio = new Audio("data:audio/mp3;base64," + data.audioContent);
                audio.play().catch(() => {});
            } catch (e) {
                const msg = new SpeechSynthesisUtterance(text);
                msg.lang = 'ja-JP';
                window.speechSynthesis.speak(msg);
            }
        }

        async function handleAnswer(q) {
            if (!currentCard) return;
            const now = Date.now();
            const todayStr = new Date().toLocaleDateString();
            if (currentCard.iv === 0 && !currentCard.firstSeen) currentCard.firstSeen = todayStr;
            if (q < 3) { currentCard.iv = 0; currentCard.next = now + 60000; } 
            else if (q === 3) { currentCard.iv = (currentCard.iv === 0) ? 0.5 : Math.ceil(currentCard.iv * 1.2); currentCard.next = now + 600000; } 
            else { currentCard.iv = (currentCard.iv === 0) ? 1 : Math.ceil(currentCard.iv * 2.5); currentCard.next = now + (currentCard.iv * 86400000); }
            localStorage.setItem('anki_jp_db', JSON.stringify(words));
            nextCard();
            fetch(gasUrl, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ action: "push", data: words }) });
        }

        // 2. 補回 toggleAnswer 函數
        function toggleAnswer() {
            if (!currentCard) return;
            document.getElementById('translationDisplay').style.display = 'block';
            document.querySelector('.btn-group').style.display = 'grid';
            document.getElementById('tapTip').style.display = 'none';
        }

        init();
    </script>
</body>
</html>
