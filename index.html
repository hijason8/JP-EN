<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JP-EN Flashcards</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="JP-EN">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/hijason8/JP-EN/main/snapchat.png">
    <style>
        /* é€™è£¡æ”¾ä½ åŸæœ¬çš„ CSS æ¨£å¼ */
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f4f4f9; }
        .card { background: white; padding: 40px 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin: 20px auto; max-width: 400px; min-height: 200px; cursor: pointer; }
        #wordDisplay { font-size: 48px; margin-bottom: 20px; }
        #translationDisplay { font-size: 24px; color: #666; display: none; }
        .btn-group { display: none; grid-template-columns: 1fr 1fr 1fr; gap: 10px; max-width: 400px; margin: 20px auto; }
        button { padding: 15px; border: none; border-radius: 8px; color: white; font-size: 16px; cursor: pointer; }
        .btn-again { background: #ff4444; }
        .btn-hard { background: #ffbb33; }
        .btn-easy { background: #00C851; }
        #countDisplay { margin-top: 20px; font-size: 14px; color: #888; }
        #tapTip { color: #bbb; font-size: 14px; }
    </style>
</head>
<body>

    <div class="card" onclick="toggleAnswer()">
        <div id="wordDisplay">Loading...</div>
        <div id="translationDisplay"></div>
        <div id="tapTip">Tap to reveal</div>
    </div>

    <div class="btn-group">
        <button class="btn-again" onclick="handleAnswer(1)">Again</button>
        <button class="btn-hard" onclick="handleAnswer(3)">Hard</button>
        <button class="btn-easy" onclick="handleAnswer(5)">Easy</button>
    </div>

    <div id="countDisplay">Connecting to cloud...</div>

    <script>
        // 1. è¨­å®šèˆ‡å…¨åŸŸè®Šæ•¸
const gasUrl = "https://script.google.com/macros/s/AKfycbzPkfNIp5y_hjT75Hv3ELbp7Uo6NBeXFIyvff2G_Dx7QEOPw6AZ3yUb-W4d7VJxkHH60A/exec";
const NEW_CARDS_LIMIT = 20;
let words = [];
let currentCard = null;

// 2. UI æ¸²æŸ“å‡½æ•¸ (å¿…é ˆæ”¾åœ¨å‰é¢ï¼Œç¢ºä¿ nextCard å‘¼å«å¾—åˆ°å®ƒ)
function renderUI(dueCount, learnedCount) {
    const wordDisp = document.getElementById('wordDisplay');
    const transDisp = document.getElementById('translationDisplay');
    const countDisp = document.getElementById('countDisplay');
    const btnGroup = document.querySelector('.btn-group');
    const tapTip = document.getElementById('tapTip');

    if (!currentCard) {
        let laterToday = words.filter(w => w.iv >= 0 && w.next > Date.now() && w.next <= new Date().setHours(23,59,59,999));
        wordDisp.innerText = (laterToday.length > 0) ? "Queue Cleared" : "All Done!";
        transDisp.innerText = (laterToday.length > 0) ? `${laterToday.length} cards scheduled for later.` : "See you tomorrow!";
        transDisp.style.display = 'block';
        if(btnGroup) btnGroup.style.display = 'none';
        if(tapTip) tapTip.style.display = 'none';
        countDisp.innerText = `New Today: ${learnedCount}/${NEW_CARDS_LIMIT}`;
        return;
    }

    wordDisp.innerText = currentCard.w;
    transDisp.innerText = currentCard.t;
    transDisp.style.display = 'none';
    if(btnGroup) btnGroup.style.display = 'none';
    if(tapTip) tapTip.style.display = 'block';
    countDisp.innerText = `Due: ${dueCount} | New Today: ${learnedCount}/${NEW_CARDS_LIMIT}`;
    speak(currentCard.w);
}

function nextCard() {
    const now = Date.now();
    // ä½¿ç”¨æœ¬åœ°æ—¥æœŸå­—ä¸²ï¼Œé¿é–‹ ISO æ™‚å€åå·®
    const todayStr = new Date().toLocaleDateString('zh-TW'); 
    
    // 1. è¤‡ç¿’é¡Œï¼šè¦æœ‰ interval ä¸”æ™‚é–“å·²åˆ°
    let dueWords = words.filter(w => {
        return Number(w.iv) > 0 && w.next > 0 && w.next <= now;
    });

    // 2. è¨ˆç®—ä»Šå¤©å·²å­¸æ–°è©
    let learnedNewToday = words.filter(w => {
        if (!w.firstSeen || w.firstSeen === "0" || w.firstSeen === "") return false;
        try {
            // å°‡å­˜ä¸‹çš„æ—¥æœŸä¹Ÿè½‰ç‚ºæœ¬åœ°æ—¥æœŸå­—ä¸²æ¯”å°
            const fsDate = new Date(w.firstSeen).toLocaleDateString('zh-TW');
            return fsDate === todayStr && Number(w.iv) > 0;
        } catch(e) { return false; }
    }).length;

    if (dueWords.length > 0) {
        // å„ªå…ˆæŠ½è¤‡ç¿’é¡Œ
        let pool = dueWords.length > 1 ? dueWords.filter(w => w.w !== (currentCard ? currentCard.w : "")) : dueWords;
        currentCard = pool[Math.floor(Math.random() * pool.length)];
    } else if (learnedNewToday < NEW_CARDS_LIMIT) {
        // æŠ½æ–°è©ï¼šiv ç‚º 0 ä¸”æ²’æœ‰å­¸ç¿’æ—¥æœŸç´€éŒ„
        let newWords = words.filter(w => {
            let isNew = Number(w.iv) === 0;
            let noDate = !w.firstSeen || w.firstSeen === "0" || w.firstSeen === "";
            return isNew && noDate;
        });
        currentCard = newWords.length > 0 ? newWords[0] : null;
    } else {
        currentCard = null;
    }

    renderUI(dueWords.length, learnedNewToday);
}

// 4. åˆå§‹åŒ–
async function init() {
    try {
        // âœ… å¿…é ˆåŒ…å« redirect: 'follow'
        const res = await fetch(`${gasUrl}?action=pull`, {
            method: 'GET',
            redirect: 'follow' 
        });
        
        if (!res.ok) throw new Error("Fetch failed");
        
        words = await res.json();
        console.log("è³‡æ–™æŠ“å–æˆåŠŸï¼Œç¸½é‡ï¼š", words.length);
        
    } catch (e) {
        console.error("é›²ç«¯é€£ç·šå¤±æ•—:", e);
        words = JSON.parse(localStorage.getItem('anki_jp_db')) || [];
    }
    nextCard(); // ğŸ‘ˆ æŠ“å®Œè³‡æ–™å¾Œï¼ŒåŸ·è¡Œé€™å€‹æ‰æœƒé–‹å§‹é¡¯ç¤ºå–®å­—
}

// 5. å…¶ä»–åŠŸèƒ½ (ç™¼éŸ³èˆ‡ç­”æ¡ˆè™•ç†)
async function speak(text) {
    try {
        const res = await fetch(`${gasUrl}?action=speak&text=${encodeURIComponent(text)}`);
        const data = await res.json();
        const audio = new Audio("data:audio/mp3;base64," + data.audioContent);
        audio.play().catch(() => {});
    } catch (e) {
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'ja-JP';
        window.speechSynthesis.speak(msg);
    }
}

async function handleAnswer(q) {
    if (!currentCard) return;
    const now = Date.now();
    
    // 1. ä¿®æ­£æ—¥æœŸåˆ¤å®šï¼šçµ±ä¸€ä½¿ç”¨æœ¬åœ°åŒ–å­—ä¸²ï¼Œä¸¦è€ƒæ…® "0" çš„æƒ…æ³
    const todayStr = new Date().toLocaleDateString();
    if ((Number(currentCard.iv) === 0) && (!currentCard.firstSeen || currentCard.firstSeen === "0" || currentCard.firstSeen === "")) {
        currentCard.firstSeen = todayStr;
    }

    // 2. ä¿®æ­£ Next æ™‚é–“è¨ˆç®—ï¼šEasy æ‡‰è©²æ˜¯æ ¹æ“š interval å¢åŠ å¤©æ•¸ï¼Œè€Œä¸æ˜¯å›ºå®šåŠ ä¸€å¤©
    if (q < 3) { // Again
        currentCard.iv = 0; 
        currentCard.next = now + 60000; 
    } else if (q === 3) { // Hard
        currentCard.iv = (Number(currentCard.iv) === 0) ? 0.5 : Math.ceil(currentCard.iv * 1.2);
        currentCard.next = now + 600000; 
    } else { // Easy
        currentCard.iv = (Number(currentCard.iv) === 0) ? 1 : Math.ceil(currentCard.iv * 2.5);
        // âœ… ä¿®æ­£ï¼šæ ¹æ“šæ–°çš„ iv è¨ˆç®—å¤©æ•¸ (iv * 24 * 60 * 60 * 1000)
        currentCard.next = now + (currentCard.iv * 86400000); 
    }
    
    localStorage.setItem('anki_jp_db', JSON.stringify(words));
    
    // å…ˆåŸ·è¡Œä¸‹ä¸€é¡Œ UI æ‰æœƒå³æ™‚æ›´æ–°
    nextCard();

    // 3. ä¿®æ­£ Fetch çš„èªæ³•éŒ¯èª¤ï¼šæ˜¯ headers (åŠ  s)ï¼Œä¸æ˜¯ header
    try {
        fetch(gasUrl, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" }, // âœ… ä¿®æ­£é€™è£¡
            body: JSON.stringify({ action: "push", data: words })
        });
    } catch (e) {
        console.error("Push failed:", e);
    }
}
function toggleAnswer() {
    if (!currentCard) return;
    
    // 1. é¡¯ç¤ºç¿»è­¯
    const transDisp = document.getElementById('translationDisplay');
    if (transDisp) transDisp.style.display = 'block';
    
    // 2. é¡¯ç¤ºæŒ‰éˆ•çµ„ (Again/Hard/Easy)
    const btnGroup = document.querySelector('.btn-group');
    if (btnGroup) btnGroup.style.display = 'grid'; // æ³¨æ„é€™è£¡ç”¨ grid é…åˆä½ çš„ CSS
    
    // 3. éš±è—æç¤ºæ–‡å­—
    const tapTip = document.getElementById('tapTip');
    if (tapTip) tapTip.style.display = 'none';
}

// å•Ÿå‹•ç¨‹å¼
init();
    </script>
</body>
</html>
